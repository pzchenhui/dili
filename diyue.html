<!DOCTYPE html>
<html>
<head>
    <title>3D地月系统演示（优化版）</title>
    <style>
        body { margin: 0; }
        canvas { display: block; }
        #info {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            font-family: Arial;
            z-index: 100;
        }
        #loader {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: Arial;
        }
    </style>
</head>
<body>
    <div id="info">昼夜循环中 | 右键拖拽旋转 | 滚轮缩放</div>
    <div id="loader">正在加载资源: 0%</div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script>
        // 配置参数
        const CONFIG = {
            EARTH: {
                RADIUS: 3,
                ROTATION_SPEED: 0.002,
                TEXTURE: 'https://threejs.org/examples/textures/planets/earth_atmos_2048.jpg',
                CLOUDS: 'https://threejs.org/examples/textures/planets/earth_clouds_1024.png'
            },
            MOON: {
                RADIUS_RATIO: 0.27,
                ORBIT_RADIUS: 10,
                TEXTURE: 'https://threejs.org/examples/textures/planets/moon_1024.jpg'
            },
            SUN: {
                RADIUS: 6,
                COLOR: 0xFFD700,
                DISTANCE: 30
            },

        };

        let scene, camera, renderer, controls;
        let earth, moon, sunLight, sunMesh;
        let time = 0;
        const textureLoader = new THREE.TextureLoader();
        const loaderElement = document.getElementById('loader');
        let totalLoaded = 0;
        const totalToLoad = 3;

        // 加载纹理时更新进度
        function onProgress(url, loaded, total) {
            totalLoaded++;
            const progress = (totalLoaded / totalToLoad) * 100;
            loaderElement.textContent = `正在加载资源: ${Math.round(progress)}%`;
        }

        async function init() {
            // 初始化场景
            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x000000);

            // 初始化相机
            camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000);
            camera.position.set(0, 15, 25).multiplyScalar(0.8);
            camera.lookAt(0, 0, 0);

            // 初始化渲染器
            renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                powerPreference: "high-performance"
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // 预加载纹理
            const textures = await Promise.all([
                textureLoader.loadAsync(CONFIG.EARTH.TEXTURE, (xhr) => onProgress(CONFIG.EARTH.TEXTURE, xhr.loaded, xhr.total)),
                textureLoader.loadAsync(CONFIG.EARTH.CLOUDS, (xhr) => onProgress(CONFIG.EARTH.CLOUDS, xhr.loaded, xhr.total)),
                textureLoader.loadAsync(CONFIG.MOON.TEXTURE, (xhr) => onProgress(CONFIG.MOON.TEXTURE, xhr.loaded, xhr.total))
            ]);

            // 创建天体系统
            createSun();
            await createEarth(textures);
            createMoon(textures[2]);

            // 设置轨道控制器
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;

            // 隐藏加载提示
            loaderElement.style.display = 'none';
        }

        function createSun() {
            // 太阳光源
            sunLight = new THREE.DirectionalLight(0xFFFFFF, 2.5);
            sunLight.position.set(CONFIG.SUN.DISTANCE, 0, 0);
            scene.add(sunLight, sunLight.target);

            // 太阳模型
            sunMesh = new THREE.Mesh(
                new THREE.SphereGeometry(CONFIG.SUN.RADIUS, 32, 32),
                new THREE.MeshBasicMaterial({
                    color: CONFIG.SUN.COLOR,
                    transparent: true,
                    opacity: 0.9
                })
            );
            scene.add(sunMesh);
        }

        async function createEarth([earthTex, cloudTex]) {
            // 地球主体
            earth = new THREE.Mesh(
                new THREE.SphereGeometry(CONFIG.EARTH.RADIUS, 64, 64),
                new THREE.MeshPhongMaterial({
                    map: earthTex,
                    bumpScale: 0.2,
                    specular: 0x444444,
                    shininess: 10
                })
            );
            earth.rotation.x = -23.4 * Math.PI/180;
            scene.add(earth);

            // 云层
            const clouds = new THREE.Mesh(
                new THREE.SphereGeometry(CONFIG.EARTH.RADIUS * 1.01, 64, 64),
                new THREE.MeshPhongMaterial({
                    map: cloudTex,
                    transparent: true,
                    opacity: 0.9
                })
            );
            earth.add(clouds);
        }

      function createMoon(moonTex) {
            moon = new THREE.Mesh(
                new THREE.SphereGeometry(CONFIG.EARTH.RADIUS * CONFIG.MOON.RADIUS_RATIO, 32, 32),
                new THREE.MeshPhongMaterial({ 
                    map: moonTex,
                    bumpScale: 0.1
                })
            );
            scene.add(moon);
        }

        function animate() {
            requestAnimationFrame(animate);
            time += 0.003;

            // 地球自转
            earth.rotation.y += CONFIG.EARTH.ROTATION_SPEED;

            // 月球公转
            const moonAngle = time * 2.5;
            moon.position.set(
                Math.cos(moonAngle) * CONFIG.MOON.ORBIT_RADIUS,
                Math.sin(moonAngle) * 3,
                Math.sin(moonAngle) * CONFIG.MOON.ORBIT_RADIUS
            );
            moon.lookAt(earth.position);

            // 太阳运动
            const sunAngle = time/2;
            sunLight.position.set(
                Math.cos(sunAngle) * CONFIG.SUN.DISTANCE,
                Math.sin(sunAngle) * 5,
                Math.sin(sunAngle) * CONFIG.SUN.DISTANCE
            );
            sunMesh.position.copy(sunLight.position);
            sunLight.target.position.copy(earth.position);

            controls.update();
            renderer.render(scene, camera);
        }

        // 窗口大小调整处理
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // 启动
        init().then(animate);
    </script>
</body>
</html>